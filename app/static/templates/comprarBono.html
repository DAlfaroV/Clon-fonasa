<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Comprar Bono Médico</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/bono.css') }}" />
</head>
<body>
  <img src="{{ url_for('static', filename='image/fonasa.png') }}" alt="Logo Fonasa" class="logo" />

  <div id="buscar-medicos" class="container">
    <h2>Buscar Médicos (Región: {{ session['region'] }})</h2>

    {% with mensajes = get_flashed_messages(with_categories=true) %}
      {% if mensajes %}
        <ul class="flash-messages">
          {% for categoria, texto in mensajes %}
            <li class="alert-{{ categoria }}">{{ texto }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form id="formBuscarMedicos" method="get" action="{{ url_for('comprar_bono') }}">
      <div class="form-grid">
        <div class="form-group col-6">
          <label for="tipoBusqueda">Tipo de Búsqueda:</label>
          <select id="tipoBusqueda" class="form-control" onchange="mostrarCamposBusqueda()">
            <option value="nombre">Por Nombre Profesional</option>
            <option value="rutProfesional">Por RUT Profesional</option>
          </select>
        </div>

        <div class="form-group col-6" id="campoBusquedaDinamica">
          <label for="valorBusqueda">Nombre Profesional:</label>
          <input type="text" id="valorBusqueda" name="valorBusqueda" class="form-control" placeholder="Ej: Juan Pérez"/>
        </div>

        <div class="form-group col-4">
          <label for="especialidad">Especialidad:</label>
          <select id="especialidad" name="especialidad" class="form-control">
            <option value="">-- Seleccione especialidad --</option>
            <option value="cardiologia">Cardiología</option>
            <option value="pediatria">Pediatría</option>
            <option value="dermatologia">Dermatología</option>
            <option value="medicina_general">Medicina General</option>
          </select>
        </div>

        <div class="form-group col-4">
          <label for="region">Región:</label>
          <input type="text" id="region" class="form-control" 
                 value="{{ session['region'] }}" readonly/>
        </div>

        <div class="form-group col-4">
          <label for="comuna">Comuna:</label>
          <select id="comuna" name="comuna" class="form-control">
            <option value="">-- Seleccione comuna --</option>
          </select>
        </div>
      </div>

      <div class="text-end">
        <button type="submit">Buscar Médicos</button>
      </div>
    </form>
  </div>
  <div id="resultados" style="margin-top: 40px;" class="container">
    <h3 style="margin-bottom: 15px; color: #333;">Resultados Encontrados</h3>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>RUT</th>
          <th>Especialidad</th>
          <th>Región</th>
          <th>Comuna</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        <!-- 
          --> 
        <tr>
          <td>Juan Pérez</td>
          <td>12.345.678-9</td>
          <td>Cardiología</td>
          <td>Metropolitana</td>
          <td>Las Condes</td>
          <td>
            <button onclick="abrirModal('Dr. Juan Pérez', 'Cardiología')" 
                    style="background-color: #28a745; padding: 6px 10px; font-size: 0.9rem; border-radius: 5px;">
              Comprar Bono
            </button>
          </td>
        </tr>
        <tr>
          <td>María González</td>
          <td>98.765.432-1</td>
          <td>Pediatría</td>
          <td>Valparaíso</td>
          <td>Viña del Mar</td>
          <td>
            <button onclick="abrirModal('Dra. María González', 'Pediatría')"
                    style="background-color: #28a745; padding: 6px 10px; font-size: 0.9rem; border-radius: 5px;">
              Comprar Bono
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <p style="margin-top: 10px; font-size: 0.9rem; color: #888;">
      <em>⚠️ Estos datos son de prueba. Serán reemplazados cuando haya conexión con la base de datos.</em>
    </p>
  </div>

  <div id="modalBono" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h2>Detalle del Bono</h2>
      <p><strong>Médico:</strong> <span id="nombreMedico"></span></p>
      <p><strong>Especialidad:</strong> <span id="especialidadModal"></span></p>
      <p><strong>Copago:</strong> $<span id="copagoModal"></span></p>
      <p><strong>Total:</strong> $<span id="totalModal"></span></p>
      <form id="formConfirmarCompra" method="post" action="{{ url_for('comprar_bono') }}">
        <input type="hidden" name="id_bono" id="inputIdBono">
        <input type="hidden" name="fecha_emision" id="inputFecha">
        <input type="hidden" name="descripcion" id="inputDescripcion">
        <input type="hidden" name="valor_total" id="inputValorTotal">
        <input type="hidden" name="valor_copago" id="inputValorCopago">
        <input type="hidden" name="valor_apagar" id="inputValorApagar">
        <input type="hidden" name="rut_medico" id="inputRutMedico">
        <button type="submit">Confirmar Compra</button>
      </form>
    </div>
  </div>

  <script>
    const comunasPorRegion = {
      metropolitana: ['Santiago', 'Las Condes', 'La Florida', 'Puente Alto'],
      valparaiso: ['Valparaíso', 'Viña del Mar', 'Quilpué', 'Villa Alemana'],
      biobio: ['Concepción', 'Talcahuano', 'Chiguayante', 'Hualpén']
    };

    function cargarComunas() {
      const region = document.getElementById('region').value.toLowerCase();
      const comunaSelect = document.getElementById('comuna');
      comunaSelect.innerHTML = '<option value="">-- Seleccione comuna --</option>';
      if (region && comunasPorRegion[region]) {
        comunasPorRegion[region].forEach(comuna => {
          const option = document.createElement('option');
          option.value = comuna.toLowerCase().replace(/\s/g, '_');
          option.textContent = comuna;
          comunaSelect.appendChild(option);
        });
      }
    }

    function mostrarCamposBusqueda() {
      const tipo = document.getElementById('tipoBusqueda').value;
      const label = document.querySelector('#campoBusquedaDinamica label');
      const input = document.getElementById('valorBusqueda');

      if (tipo === 'nombre') {
        label.textContent = 'Nombre Profesional:';
        input.placeholder = 'Ej: Juan Pérez';
      } else {
        label.textContent = 'RUT Profesional:';
        input.placeholder = 'Ej: 12345678-9';
      }
    }

    window.onload = () => {
      mostrarCamposBusqueda();
      document.getElementById('region').addEventListener('change', cargarComunas);
    };

    function abrirModal(nombre, especialidad) {
      document.getElementById('nombreMedico').textContent = nombre;
      document.getElementById('especialidadModal').textContent = especialidad;

      const copago = Math.floor(Math.random() * 5000 + 5000); // Entre $5.000 y $10.000
      const total = copago + 10000;

      document.getElementById('copagoModal').textContent = copago.toLocaleString();
      document.getElementById('totalModal').textContent = total.toLocaleString();

      document.getElementById('inputIdBono').value = 'BONO-' + Date.now();
      document.getElementById('inputFecha').value = new Date().toISOString().split('T')[0];
      document.getElementById('inputDescripcion').value = `Bono para ${nombre}`;
      document.getElementById('inputValorTotal').value = total;
      document.getElementById('inputValorCopago').value = copago;
      document.getElementById('inputValorApagar').value = total - copago;
      document.getElementById('inputRutMedico').value = 'RUT-' + nombre.replace(/\s/g, '').slice(0, 5);

      document.getElementById('modalBono').style.display = 'block';
    }

    function cerrarModal() {
      document.getElementById('modalBono').style.display = 'none';
    }
  </script>
</body>
</html>
